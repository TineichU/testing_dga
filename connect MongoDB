# Local imports
import datetime

# Third part imports
from flask import request
import pandas as pd
from flask import Flask
from pymongo import MongoClient
def _connect_mongo(host, port, username, password, db):
    """ A util for making a connection to mongo """

    if username and password:
        mongo_uri = 'mongodb://%s:%s@%s:%s/%s' % (username, password, host, port, db)
        conn = MongoClient(mongo_uri)
    else:
        conn = MongoClient(host, port)


    return conn[db]

def read_mongo(db, collection_dga,collection_time, query={}, host='localhost', port=27017, username=None, password=None):
    """ Read from Mongo and Store into DataFrame """

    # Connect to MongoDB
    db = _connect_mongo(host=host, port=port, username=username, password=password, db=db)
    limit = 1000
    cursor_timestamp = db[collection_time].find({}, {"time": 1, "_id": 0})
    cursor_timestamp = list(cursor_timestamp)
    cursor_timestamp = cursor_timestamp[0]['time']
    #в этом цикле будет анализ домена, потом по функциям разбить
    while True:
        cursor_domain_time = db[collection_dga].find({"@timestamp": {"$gt": cursor_timestamp}}, {"dns_query_name": 1, "@timestamp":1,"_id":0}).limit(1000)
        df = pd.DataFrame(list(cursor_domain_time))
        if df.empty:
            break
        cursor_timestamp = df['@timestamp'][df.index[-1]]
    #тут вывод

    return df


app = Flask(__name__)

@app.post('/predict')
def predict():
    df = read_mongo(db='dga_detection', host='10.101.26.246',collection_dga='dns_data', collection_time='timestamp')
    return 1,200


if __name__ == '__main__':
    app.run(host='0.0.0.0')

